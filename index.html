<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ˜­å›åƒéª¨é ­ï½œDog Park Snake</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #020617;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .wrapper { text-align: center; }
    canvas {
      border-radius: 16px;
      box-shadow: 0 0 30px rgba(0,0,0,0.6);
      background: #000;
      display: block;
      margin: 0 auto 10px;
    }
    .hint {
      font-size: 14px;
      color: #cbd5f5;
      margin-top: 4px;
    }

    /* --- ä¸»é¸å–® Overlay --- */
    .overlay {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: auto;
      z-index: 20;
    }
    .overlay.hidden { display: none; }

    .menu-card {
      background: rgba(15,23,42,0.96);
      border-radius: 20px;
      padding: 24px 28px 20px;
      width: 420px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.65);
    }
    .menu-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .mode-tabs {
      display: flex;
      margin-bottom: 14px;
      border-radius: 999px;
      background: #020617;
      padding: 3px;
      gap: 4px;
    }
    .mode-tab {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 8px 0;
      font-size: 14px;
      cursor: pointer;
      background: transparent;
      color: #9ca3af;
      transition: all 0.18s ease-out;
    }
    .mode-tab.active {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 0 12px rgba(34,197,94,0.6);
    }

    .menu-row {
      text-align: left;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .menu-row label {
      display: block;
      margin-bottom: 4px;
      color: #e5e7eb;
    }
    .menu-row input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #334155;
      padding: 8px 10px;
      outline: none;
      background: #020617;
      color: #f9fafb;
      font-size: 14px;
    }
    .menu-row input::placeholder { color: #6b7280; }

    .menu-actions {
      margin-top: 12px;
      display: flex;
      justify-content: center;
    }
    .primary-btn {
      border-radius: 999px;
      border: none;
      padding: 10px 30px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      box-shadow: 0 0 18px rgba(34,197,94,0.7);
      transition: transform 0.12s ease-out, box-shadow 0.12s;
    }
    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 24px rgba(34,197,94,0.95);
    }
    .primary-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 0 12px rgba(34,197,94,0.6);
    }
    .menu-small-hint {
      margin-top: 10px;
      font-size: 12px;
      color: #9ca3af;
      text-align: left;
    }
    .hidden { display: none; }

    /* --- å€’æ•¸æ³¡æ³¡ --- */
    #countdownOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
      z-index: 30;
    }
    #countdownOverlay.hidden { display: none; }

    #countdownBubble {
      width: 120px;
      height: 120px;
      border-radius: 999px;
      background: rgba(15,23,42,0.92);
      color: #f9fafb;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 64px;
      font-weight: 700;
      box-shadow: 0 12px 30px rgba(0,0,0,0.7);
      animation: pop 0.9s ease-out forwards;
    }
    @keyframes pop {
      0%   { transform: scale(0.3); opacity: 0; }
      25%  { transform: scale(1.1); opacity: 1; }
      80%  { transform: scale(1.0); opacity: 1; }
      100% { transform: scale(0.5); opacity: 0; }
    }
  </style>
</head>
<body>
<div class="wrapper">
  <canvas id="game"></canvas>
  <div class="hint">
    âŒ¨ï¸ å–®äººï¼šæ–¹å‘éµ / WASD ï½œ é›™äººï¼šP1ï¼WASDï¼ŒP2ï¼æ–¹å‘éµ ï½œ R å†ç©ä¸€æ¬¡ ï½œ M å›ä¸»é¸å–®
  </div>
</div>

<!-- ä¸»é¸å–® -->
<div id="menuOverlay" class="overlay">
  <div class="menu-card">
    <div class="menu-title">ğŸ¶ æ˜­å›åƒéª¨é ­</div>
    <div class="mode-tabs">
      <button id="tabSingle" class="mode-tab active">å–®äººæ’è¡Œ</button>
      <button id="tabVersus" class="mode-tab">é›™äººå°æˆ°</button>
    </div>

    <!-- å–®äººè¨­å®š -->
    <div id="panelSingle">
      <div class="menu-row">
        <label>ç©å®¶åç¨±</label>
        <input id="singleNameInput" type="text" placeholder="ä¾‹å¦‚ï¼šLexi" />
      </div>
      <div class="menu-actions">
        <button id="btnStartSingle" class="primary-btn">é–‹å§‹å–®äººéŠæˆ²</button>
      </div>
      <div class="menu-small-hint">
        â–¸ æ“ä½œï¼šæ–¹å‘éµ / WASD çš†å¯<br>
        â–¸ æ’ç‰†æœƒå¾å¦ä¸€å´ç©¿å‡ºï¼Œæ’åˆ°è‡ªå·±å°± Game Over
      </div>
    </div>

    <!-- é›™äººè¨­å®š -->
    <div id="panelVersus" class="hidden">
      <div class="menu-row">
        <label>P1 åç¨±ï¼ˆWASDï¼‰</label>
        <input id="p1NameInput" type="text" placeholder="ä¾‹å¦‚ï¼šPlayer 1" />
      </div>
      <div class="menu-row">
        <label>P2 åç¨±ï¼ˆæ–¹å‘éµï¼‰</label>
        <input id="p2NameInput" type="text" placeholder="ä¾‹å¦‚ï¼šPlayer 2" />
      </div>
      <div class="menu-actions">
        <button id="btnStartVersus" class="primary-btn">é–‹å§‹é›™äººå°æˆ°</button>
      </div>
      <div class="menu-small-hint">
        â–¸ P1ï¼šWASD æ§åˆ¶å·¦ä¸Šç‹—ç‹— ğŸ•<br>
        â–¸ P2ï¼šæ–¹å‘éµæ§åˆ¶å·¦ä¸‹ç‹—ç‹— ğŸ©<br>
        â–¸ æ’ç‰†æœƒç©¿å‡ºï¼›æ’åˆ°è‡ªå·±æˆ–å°æ‰‹ï¼ˆå«é ­æ’é ­ï¼‰å°±çµæŸ
      </div>
    </div>
  </div>
</div>

<!-- å€’æ•¸æ³¡æ³¡ -->
<div id="countdownOverlay" class="hidden">
  <div id="countdownBubble">3</div>
</div>

<script>
  // ======== éŸ³æ•ˆ ========
  const boneSound       = new Audio("bone.wav");
  const gameoverSound   = new Audio("gameover_waiwai.wav");
  const countdownSound  = new Audio("countdown.wav");
  boneSound.volume      = 0.9;
  gameoverSound.volume  = 0.9;
  countdownSound.volume = 0.9;

  // ======== éŠæˆ²è¨­å®š ========
  const CELL_SIZE   = 24;
  const GRID_WIDTH  = 30;
  const GRID_HEIGHT = 30;
  const WIDTH  = CELL_SIZE * GRID_WIDTH;
  const HEIGHT = CELL_SIZE * GRID_HEIGHT;

  const SKY_COLOR   = "#9fd5ff";
  const GRASS_COLOR = "#15803d";
  const PATH_COLOR  = "#4b5563";

  // é€Ÿåº¦ï¼šä¸€é–‹å§‹æ…¢ä¸€é»ï¼Œæ¯ 10 åˆ†ç¨å¾®åŠ å¿«
  const BASE_SPEED = 150; // ms
  const MIN_SPEED  = 90;
  const SPEED_STEP = 20;

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  canvas.width  = WIDTH;
  canvas.height = HEIGHT;

  // ======== ç‹€æ…‹è®Šæ•¸ ========
  let currentMode  = "menu"; // 'menu' | 'single' | 'versus'
  let gameRunning  = false;
  let gameOver     = false;
  let countingDown = false;

  // å€’æ•¸
  const countdownOverlay = document.getElementById("countdownOverlay");
  const countdownBubble  = document.getElementById("countdownBubble");

  // Menu å…ƒä»¶
  const menuOverlay      = document.getElementById("menuOverlay");
  const tabSingle        = document.getElementById("tabSingle");
  const tabVersus        = document.getElementById("tabVersus");
  const panelSingle      = document.getElementById("panelSingle");
  const panelVersus      = document.getElementById("panelVersus");
  const singleNameInput  = document.getElementById("singleNameInput");
  const p1NameInput      = document.getElementById("p1NameInput");
  const p2NameInput      = document.getElementById("p2NameInput");
  const btnStartSingle   = document.getElementById("btnStartSingle");
  const btnStartVersus   = document.getElementById("btnStartVersus");

  // å–®äººç‹€æ…‹
  let singleName = "Lexi";
  let singleSnake = [];
  let singleDir = { x: 1, y: 0 };
  let singlePendingDir = { x: 1, y: 0 };
  let singleScore = 0;

  // é›™äººç‹€æ…‹
  let p1Name = "Player 1";
  let p2Name = "Player 2";
  let p1Snake = [];
  let p2Snake = [];
  let p1Dir = { x: 1, y: 0 };
  let p2Dir = { x: 1, y: 0 };
  let p1PendingDir = { x: 1, y: 0 };
  let p2PendingDir = { x: 1, y: 0 };
  let p1Score = 0;
  let p2Score = 0;
  let versusResultText = "";

  // å…±ç”¨é£Ÿç‰©
  let food = null;

  // Game Over æè¿°
  let gameOverTitle = "";
  let gameOverSub   = "";

  // æ™‚é–“ç´¯ç©
  let lastTimestamp = 0;
  let accumulator   = 0;

  // ======== å°å·¥å…· ========
  function wrapPosition(pos) {
    let x = pos.x;
    let y = pos.y;
    if (x < 0) x = GRID_WIDTH - 1;
    if (x >= GRID_WIDTH) x = 0;
    if (y < 0) y = GRID_HEIGHT - 1;
    if (y >= GRID_HEIGHT) y = 0;
    return { x, y };
  }

  function randomFoodPosition(snakeArrays) {
    while (true) {
      const x = Math.floor(Math.random() * GRID_WIDTH);
      const y = Math.floor(Math.random() * GRID_HEIGHT);
      let conflict = false;
      for (const arr of snakeArrays) {
        for (const s of arr) {
          if (s.x === x && s.y === y) {
            conflict = true;
            break;
          }
        }
        if (conflict) break;
      }
      if (!conflict) return { x, y };
    }
  }

  function getCurrentSpeed() {
    let s = BASE_SPEED;
    if (currentMode === "single") {
      const lvl = Math.floor(singleScore / 10);
      s = BASE_SPEED - lvl * SPEED_STEP;
    } else if (currentMode === "versus") {
      const maxScore = Math.max(p1Score, p2Score);
      const lvl = Math.floor(maxScore / 10);
      s = BASE_SPEED - lvl * SPEED_STEP;
    }
    if (s < MIN_SPEED) s = MIN_SPEED;
    return s;
  }

  // ======== èƒŒæ™¯ ========
  function drawBackground() {
    // å¤©ç©º
    ctx.fillStyle = SKY_COLOR;
    ctx.fillRect(0, 0, WIDTH, HEIGHT * 0.4);

    // è‰åœ°
    ctx.fillStyle = GRASS_COLOR;
    ctx.fillRect(0, HEIGHT * 0.4, WIDTH, HEIGHT * 0.6);

    // å°è·¯
    const pathWidth = CELL_SIZE * 4;
    ctx.fillStyle = PATH_COLOR;
    ctx.fillRect(
      WIDTH / 2 - pathWidth / 2,
      HEIGHT * 0.4,
      pathWidth,
      HEIGHT * 0.6
    );

    // æ¨¹æœ¨
    const treeXs = [CELL_SIZE * 3, CELL_SIZE * 7, CELL_SIZE * 22, CELL_SIZE * 26];
    for (const x of treeXs) {
      ctx.fillStyle = "#92400e";
      ctx.fillRect(x - 6, HEIGHT * 0.4 - 10, 12, 40);
      ctx.beginPath();
      ctx.fillStyle = "#16a34a";
      ctx.ellipse(
        x,
        HEIGHT * 0.4 - 20,
        20,
        24,
        0,
        0,
        Math.PI * 2
      );
      ctx.fill();
    }

    // å¤ªé™½
    ctx.font = "28px 'Apple Color Emoji','Segoe UI Emoji'";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("â˜€ï¸", WIDTH - 60, 48);
  }

  // ======== åˆå§‹åŒ–ï¼šå–®äºº ========
  function prepareSingleGame() {
    currentMode = "single";
    singleName = singleNameInput.value.trim() || "Lexi";
    singleSnake = [
      { x: 4, y: 6 },
      { x: 3, y: 6 },
      { x: 2, y: 6 }
    ];
    singleDir = { x: 1, y: 0 };
    singlePendingDir = { x: 1, y: 0 };
    singleScore = 0;
    food = randomFoodPosition([singleSnake]);
    gameOver = false;
    gameOverTitle = "";
    gameOverSub = "";
  }

  // ======== åˆå§‹åŒ–ï¼šé›™äºº ========
  function prepareVersusGame() {
    currentMode = "versus";
    p1Name = p1NameInput.value.trim() || "Player 1";
    p2Name = p2NameInput.value.trim() || "Player 2";

    // P1ï¼šå·¦ä¸Š
    p1Snake = [
      { x: 4, y: 5 },
      { x: 3, y: 5 },
      { x: 2, y: 5 }
    ];
    // P2ï¼šå·¦ä¸‹
    p2Snake = [
      { x: 4, y: GRID_HEIGHT - 6 },
      { x: 3, y: GRID_HEIGHT - 6 },
      { x: 2, y: GRID_HEIGHT - 6 }
    ];

    p1Dir = { x: 1, y: 0 };
    p2Dir = { x: 1, y: 0 };
    p1PendingDir = { x: 1, y: 0 };
    p2PendingDir = { x: 1, y: 0 };
    p1Score = 0;
    p2Score = 0;
    versusResultText = "";
    food = randomFoodPosition([p1Snake, p2Snake]);
    gameOver = false;
    gameOverTitle = "";
    gameOverSub = "";
  }

  // ======== å€’æ•¸å‹•ç•« ========
  function startCountdown(onFinish) {
    countingDown = true;
    let items = ["3", "2", "1", "GO!"];
    let index = 0;

    function next() {
      if (index >= items.length) {
        countdownOverlay.classList.add("hidden");
        countingDown = false;
        if (onFinish) onFinish();
        return;
      }
      const label = items[index];
      countdownBubble.textContent = label;
      countdownBubble.style.animation = "none";
      // é‡æ–°è§¸ç™¼å‹•ç•«
      void countdownBubble.offsetWidth;
      countdownBubble.style.animation = "pop 0.9s ease-out forwards";

      countdownOverlay.classList.remove("hidden");

      try {
        countdownSound.currentTime = 0;
        countdownSound.play().catch(()=>{});
      } catch (e) {}

      index++;
      setTimeout(next, 900);
    }
    next();
  }

  // ======== å–®äººæ›´æ–° ========
  function stepSingle() {
    singleDir = { ...singlePendingDir };
    const head = singleSnake[0];
    const newHeadWrapped = wrapPosition({ x: head.x + singleDir.x, y: head.y + singleDir.y });

    // æ’åˆ°è‡ªå·±
    if (singleSnake.some((s, i) => i !== singleSnake.length - 1 && s.x === newHeadWrapped.x && s.y === newHeadWrapped.y)) {
      gameOver = true;
      gameOverTitle = "Game Over";
      gameOverSub   = `${singleName} æ’åˆ°è‡ªå·±äº†`;
      try {
        gameoverSound.currentTime = 0;
        gameoverSound.play().catch(()=>{});
      } catch (e) {}
      return;
    }

    singleSnake.unshift(newHeadWrapped);

    // åƒåˆ°éª¨é ­
    if (newHeadWrapped.x === food.x && newHeadWrapped.y === food.y) {
      singleScore += 1;
      try {
        boneSound.currentTime = 0;
        boneSound.play().catch(()=>{});
      } catch (e) {}
      food = randomFoodPosition([singleSnake]);
    } else {
      singleSnake.pop();
    }
  }

  // ======== é›™äººæ›´æ–° ========
  function stepVersus() {
    p1Dir = { ...p1PendingDir };
    p2Dir = { ...p2PendingDir };

    const p1Head = p1Snake[0];
    const p2Head = p2Snake[0];

    const p1New = wrapPosition({ x: p1Head.x + p1Dir.x, y: p1Head.y + p1Dir.y });
    const p2New = wrapPosition({ x: p2Head.x + p2Dir.x, y: p2Head.y + p2Dir.y });

    // é ­æ’é ­
    if (p1New.x === p2New.x && p1New.y === p2New.y) {
      gameOver = true;
      gameOverTitle = "å¹³æ‰‹ï¼";
      gameOverSub   = "å…©éš»ç‹—ç‹—ä¸€èµ·æ’ä¸Šäº† ğŸ¥²";
      try {
        gameoverSound.currentTime = 0;
        gameoverSound.play().catch(()=>{});
      } catch (e) {}
      return;
    }

    // æª¢æŸ¥ P1 æ’åˆ°è‡ªå·±æˆ–å°æ‰‹
    let p1Dead = false;
    if (p1Snake.some((s, i) => i !== p1Snake.length - 1 && s.x === p1New.x && s.y === p1New.y)) {
      p1Dead = true;
    }
    if (p2Snake.some(s => s.x === p1New.x && s.y === p1New.y)) {
      p1Dead = true;
    }

    // æª¢æŸ¥ P2 æ’åˆ°è‡ªå·±æˆ–å°æ‰‹
    let p2Dead = false;
    if (p2Snake.some((s, i) => i !== p2Snake.length - 1 && s.x === p2New.x && s.y === p2New.y)) {
      p2Dead = true;
    }
    if (p1Snake.some(s => s.x === p2New.x && s.y === p2New.y)) {
      p2Dead = true;
    }

    if (p1Dead || p2Dead) {
      gameOver = true;
      if (p1Dead && p2Dead) {
        gameOverTitle = "å¹³æ‰‹ï¼";
        gameOverSub   = "å…©éš»ç‹—ç‹—åŒæ­¸æ–¼ç›¡ ğŸ¥²";
      } else if (p1Dead) {
        gameOverTitle = `${p2Name} ç²å‹ï¼`;
        gameOverSub   = `${p1Name} æ’ç‰†æˆ–æ’åˆ°å°æ‰‹äº†`;
      } else {
        gameOverTitle = `${p1Name} ç²å‹ï¼`;
        gameOverSub   = `${p2Name} æ’ç‰†æˆ–æ’åˆ°å°æ‰‹äº†`;
      }
      try {
        gameoverSound.currentTime = 0;
        gameoverSound.play().catch(()=>{});
      } catch (e) {}
      return;
    }

    // æ²’æ­» â†’ æ›´æ–°ä½ç½®
    p1Snake.unshift(p1New);
    p2Snake.unshift(p2New);

    // èª°åƒåˆ°éª¨é ­
    let p1Ate = (p1New.x === food.x && p1New.y === food.y);
    let p2Ate = (p2New.x === food.x && p2New.y === food.y);

    if (p1Ate && p2Ate) {
      p1Score += 1;
      p2Score += 1;
      try { boneSound.currentTime = 0; boneSound.play().catch(()=>{}); } catch(e){}
      food = randomFoodPosition([p1Snake, p2Snake]);
    } else if (p1Ate) {
      p1Score += 1;
      try { boneSound.currentTime = 0; boneSound.play().catch(()=>{}); } catch(e){}
      food = randomFoodPosition([p1Snake, p2Snake]);
    } else if (p2Ate) {
      p2Score += 1;
      try { boneSound.currentTime = 0; boneSound.play().catch(()=>{}); } catch(e){}
      food = randomFoodPosition([p1Snake, p2Snake]);
    } else {
      p1Snake.pop();
      p2Snake.pop();
    }
  }

  // ======== ç¹ªåœ– ========
  function drawGame() {
    ctx.clearRect(0, 0, WIDTH, HEIGHT);
    drawBackground();

    // ç•«é£Ÿç‰©
    if (food) {
      const fx = food.x * CELL_SIZE + CELL_SIZE / 2;
      const fy = food.y * CELL_SIZE + CELL_SIZE / 2;
      ctx.font = "24px 'Apple Color Emoji','Segoe UI Emoji'";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ğŸ¦´", fx, fy);
    }

    if (currentMode === "single") {
      // å–®äººï¼šç‹—ç‹—
      for (let i = 0; i < singleSnake.length; i++) {
        const seg = singleSnake[i];
        const cx = seg.x * CELL_SIZE + CELL_SIZE / 2;
        const cy = seg.y * CELL_SIZE + CELL_SIZE / 2;
        ctx.font = "24px 'Apple Color Emoji','Segoe UI Emoji'";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("ğŸ•", cx, cy);
      }

      // åˆ†æ•¸æ–‡å­—
      ctx.font = "20px -apple-system, 'Segoe UI'";
      ctx.fillStyle = "#ffffff";
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillText(`${singleName}ï¼š${singleScore} åˆ†`, 10, 10);

    } else if (currentMode === "versus") {
      // é›™äººï¼šP1 å·¦ä¸Šæ£•ç‹—ã€P2 å·¦ä¸‹ç™½ç‹—
      for (let i = 0; i < p1Snake.length; i++) {
        const seg = p1Snake[i];
        const cx = seg.x * CELL_SIZE + CELL_SIZE / 2;
        const cy = seg.y * CELL_SIZE + CELL_SIZE / 2;
        ctx.font = "24px 'Apple Color Emoji','Segoe UI Emoji'";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("ğŸ•", cx, cy);
      }
      for (let i = 0; i < p2Snake.length; i++) {
        const seg = p2Snake[i];
        const cx = seg.x * CELL_SIZE + CELL_SIZE / 2;
        const cy = seg.y * CELL_SIZE + CELL_SIZE / 2;
        ctx.font = "24px 'Apple Color Emoji','Segoe UI Emoji'";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("ğŸ©", cx, cy);
      }

      // åˆ†æ•¸æ¢
      ctx.font = "18px -apple-system, 'Segoe UI'";
      ctx.fillStyle = "#ffffff";
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillText(`${p1Name}ï¼š${p1Score} åˆ†`, 10, 10);
      ctx.textAlign = "right";
      ctx.fillText(`${p2Name}ï¼š${p2Score} åˆ†`, WIDTH - 10, 10);

      // ä¸­å¤® Versus æ–‡æœ¬
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.font = "18px -apple-system, 'Segoe UI'";
      ctx.fillText(`Versus | P1ï¼š${p1Score} åˆ† ï½œ P2ï¼š${p2Score} åˆ†`, WIDTH / 2, 10);
    }

    // Game Over ç•«é¢
    if (gameOver) {
      ctx.fillStyle = "rgba(15,23,42,0.9)";
      const w = 320, h = 140;
      const x = WIDTH / 2 - w / 2;
      const y = HEIGHT / 2 - h / 2;
      ctx.fillRect(x, y, w, h);
      ctx.strokeStyle = "#ffffff";
      ctx.strokeRect(x, y, w, h);

      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = "26px Arial";
      ctx.fillStyle = "#f97373";
      ctx.fillText(gameOverTitle || "Game Over", WIDTH / 2, HEIGHT / 2 - 25);

      ctx.font = "14px Arial";
      ctx.fillStyle = "#ffffff";
      ctx.fillText(gameOverSub || "æŒ‰ R å†ç©ä¸€æ¬¡ ï½œ M å›ä¸»é¸å–®", WIDTH / 2, HEIGHT / 2 + 10);
    }
  }

  // ======== ä¸»è¿´åœˆ ========
  function loop(timestamp) {
    if (!lastTimestamp) lastTimestamp = timestamp;
    const delta = timestamp - lastTimestamp;
    lastTimestamp = timestamp;

    accumulator += delta;

    const stepInterval = getCurrentSpeed();

    while (accumulator >= stepInterval) {
      accumulator -= stepInterval;
      if (gameRunning && !gameOver && !countingDown) {
        if (currentMode === "single") stepSingle();
        else if (currentMode === "versus") stepVersus();
      }
    }

    drawGame();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ======== æ§åˆ¶ï¼šéµç›¤ ========
  document.addEventListener("keydown", (e) => {
    if (currentMode === "single") {
      // å–®äººï¼šæ–¹å‘éµ + WASD éƒ½å¯ä»¥
      switch (e.key) {
        case "ArrowUp":
        case "w":
        case "W":
          if (singleDir.y !== 1) singlePendingDir = { x: 0, y: -1 };
          break;
        case "ArrowDown":
        case "s":
        case "S":
          if (singleDir.y !== -1) singlePendingDir = { x: 0, y: 1 };
          break;
        case "ArrowLeft":
        case "a":
        case "A":
          if (singleDir.x !== 1) singlePendingDir = { x: -1, y: 0 };
          break;
        case "ArrowRight":
        case "d":
        case "D":
          if (singleDir.x !== -1) singlePendingDir = { x: 1, y: 0 };
          break;
      }
    } else if (currentMode === "versus") {
      // é›™äººï¼šP1 WASDã€P2 æ–¹å‘éµ
      switch (e.key) {
        // P1
        case "w":
        case "W":
          if (p1Dir.y !== 1) p1PendingDir = { x: 0, y: -1 };
          break;
        case "s":
        case "S":
          if (p1Dir.y !== -1) p1PendingDir = { x: 0, y: 1 };
          break;
        case "a":
        case "A":
          if (p1Dir.x !== 1) p1PendingDir = { x: -1, y: 0 };
          break;
        case "d":
        case "D":
          if (p1Dir.x !== -1) p1PendingDir = { x: 1, y: 0 };
          break;
        // P2
        case "ArrowUp":
          if (p2Dir.y !== 1) p2PendingDir = { x: 0, y: -1 };
          break;
        case "ArrowDown":
          if (p2Dir.y !== -1) p2PendingDir = { x: 0, y: 1 };
          break;
        case "ArrowLeft":
          if (p2Dir.x !== 1) p2PendingDir = { x: -1, y: 0 };
          break;
        case "ArrowRight":
          if (p2Dir.x !== -1) p2PendingDir = { x: 1, y: 0 };
          break;
      }
    }

    // å…±ç”¨å¿«æ·éµ
    if (e.key === "r" || e.key === "R") {
      if (currentMode === "single") {
        prepareSingleGame();
        gameOver = false;
        gameRunning = true;
      } else if (currentMode === "versus") {
        prepareVersusGame();
        gameOver = false;
        gameRunning = true;
      }
    }
    if (e.key === "m" || e.key === "M") {
      // å›ä¸»é¸å–®
      currentMode = "menu";
      gameRunning = false;
      gameOver = false;
      menuOverlay.classList.remove("hidden");
    }
  });

  // ======== Menu Tab åˆ‡æ› ========
  function setModeTab(mode) {
    if (mode === "single") {
      tabSingle.classList.add("active");
      tabVersus.classList.remove("active");
      panelSingle.classList.remove("hidden");
      panelVersus.classList.add("hidden");
    } else {
      tabSingle.classList.remove("active");
      tabVersus.classList.add("active");
      panelSingle.classList.add("hidden");
      panelVersus.classList.remove("hidden");
    }
  }

  tabSingle.addEventListener("click", () => setModeTab("single"));
  tabVersus.addEventListener("click", () => setModeTab("versus"));

  // ======== æŒ‰éˆ•ï¼šé–‹å§‹å–®äºº / é›™äºº ========
  btnStartSingle.addEventListener("click", () => {
    setModeTab("single");
    menuOverlay.classList.add("hidden");
    prepareSingleGame();
    gameRunning = false;
    gameOver = false;
    startCountdown(() => {
      gameRunning = true;
    });
  });

  btnStartVersus.addEventListener("click", () => {
    setModeTab("versus");
    menuOverlay.classList.add("hidden");
    prepareVersusGame();
    gameRunning = false;
    gameOver = false;
    startCountdown(() => {
      gameRunning = true;
    });
  });

  // åˆå§‹ç•«é¢ï¼šåªé¡¯ç¤ºèƒŒæ™¯ï¼ˆmenu è“‹åœ¨ä¸Šé¢ï¼‰
  drawGame();
</script>
</body>
</html>

